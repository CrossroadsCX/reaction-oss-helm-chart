{{- if .Values.web.enabled -}}
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    app: {{ template "reactioncommerce.name" . }}
    component: web
    chart: {{ template "reactioncommerce.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
  name: {{ template "reactioncommerce.fullname" . }}-web
  namespace: {{ .Release.Namespace | quote }} 
spec:
  selector:
    matchLabels:
      app: {{ template "reactioncommerce.name" . }}
      component: web
      release: {{ .Release.Name }}
  replicas: {{ .Values.web.replicaCount }}
  template:
    metadata:
      labels:
        app: {{ template "reactioncommerce.name" . }}
        component: web
        release: {{ .Release.Name }}
    spec:
      containers:
        - name: {{ .Chart.Name }}-web
          image: "{{ .Values.web.image.repository }}:{{ .Values.web.image.tag }}"
          imagePullPolicy: {{ .Values.web.image.pullPolicy }}
          ports:
            - name: web
              containerPort: 4000
              protocol: TCP
          env:
          - name: CANONICAL_URL
            value: {{ .Values.identity.rootUrl }}
          - name: ENABLE_SPA_ROUTING
            value: "true"
          - name: EXTERNAL_GRAPHQL_URL
            value: http://localhost:3000/graphql
          - name: INTERNAL_GRAPHQL_URL
            value: http://api.reaction.localhost:3000/graphql
          - name: OAUTH2_ADMIN_PORT
            value: "4445"
          - name: OAUTH2_ADMIN_URL
            value: http://hydra.reaction.localhost:4445
          - name: OAUTH2_AUTH_URL
            value: http://localhost:4444/oauth2/auth
          - name: OAUTH2_CLIENT_ID
            value: example-storefront
          - name: OAUTH2_CLIENT_SECRET
            value: CHANGEME
          - name: OAUTH2_HOST
            value: hydra.reaction.localhost
          - name: OAUTH2_IDP_HOST_URL
            value: http://web.reaction.localhost:4100
          - name: OAUTH2_IDP_PUBLIC_CHANGE_PASSWORD_URL
            value: http://localhost:4100/account/change-password?email=EMAIL&from=FROM
          - name: OAUTH2_PUBLIC_LOGOUT_URL
            value: http://localhost:4444/oauth2/sessions/logout
          - name: OAUTH2_TOKEN_URL
            value: http://hydra.reaction.localhost:4444/oauth2/token
          - name: PORT
            value: "4000"
          - name: SEGMENT_ANALYTICS_SKIP_MINIMIZE
            value: "true"
          - name: SEGMENT_ANALYTICS_WRITE_KEY
            value: ENTER_KEY_HERE
          - name: SESSION_MAX_AGE_MS
            value: "2592000000"
          - name: SESSION_SECRET
            value: CHANGEME
          - name: STRIPE_PUBLIC_API_KEY
            value: {{ .Values.global.stripeKey }}
{{- end }}
